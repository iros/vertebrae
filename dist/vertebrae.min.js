/* vertebrae.js 0.0.0
 *
 * jQuery Plugin to mock AJAX requests for Backbone applications.
 * Tim Branyen 2011
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *
 * Date Built: Sun, 06 Nov 2011 22:28:57 GMT
 */(function(a){var b={vendor:{}},c={},d=Backbone.Router.prototype._routeToRegExp;(function(){typeof jQuery!="undefined"&&function(a){var b,c=a.jQuery,d={};c.vertebrae=function(a){c.each(a,function(a,b){d[a]=b})},b=c.vertebrae.options={testRoute:function(a,b){return a===b},delay:{404:100},passthrough:!0},c.ajaxTransport("+*",function(a,e,f){var g,h,i,j,k,l=a.type.toUpperCase();c.each(d,function(c,e){i=b.testRoute(c,a.url),k=d[c];if(i&&k[l]){j=!0;return!1}});if(!j&&b.passthrough)return null;return{send:function(a,c){if(!j)return h=window.setTimeout(function(){c(404,"error")},b.delay[404]);i=i||[],g=k[l].apply(f,i.slice(1)),h=window.setTimeout(function(){c(f.status||200,"success",{responseText:g})},k.timeout||0)},abort:function(){window.clearTimeout(h)}}})}(this),function(a,b){function d(){return c()+c()+"-"+c()+"-"+c()+"-"+c()+"-"+c()+c()+c()}function c(){return((1+Math.random())*65536|0).toString(16).substring(1)}b.Storage=function(a,b){b=b||"local",this.name=a,this.type=b+"Storage";var c=window[this.type].getItem(this.name);this.records=c&&c.split(",")||[]},a.extend(b.Storage.prototype,{save:function(){window[this.type].setItem(this.name,this.records.join(","))},create:function(a){a.id||(a.id=a.attributes.id=d()),window[this.type].setItem(this.name+"-"+a.id,JSON.stringify(a)),this.records.push(a.id.toString()),this.save();return a},update:function(b){window[this.type].setItem(this.name+"-"+b.id,JSON.stringify(b)),a.include(this.records,b.id.toString())||this.records.push(b.id.toString()),this.save();return b},find:function(a){return JSON.parse(window[this.type].getItem(this.name+"-"+a.id))},findAll:function(){return a.map(this.records,function(a){return JSON.parse(window[this.type].getItem(this.name+"-"+a))},this)},destroy:function(b){window[this.type].removeItem(this.name+"-"+b.id),this.records=a.reject(this.records,function(a){return a==b.id.toString()}),this.save();return b}});var e=b.sync;b.sync=function(b,c,d,f){typeof d=="function"&&(d={success:d,error:f});var g,h=c.localStorage||c.sessionStorage;!h&&c.collection&&(h=c.collection.localStorage||c.collection.sessionStorage);if(!h)return e.apply(this,a.toArray(arguments));switch(b){case"read":g=c.id?h.find(c):h.findAll();break;case"create":g=h.create(c);break;case"update":g=h.update(c);break;case"delete":g=h.destroy(c)}g?d.success(g):d.error("Record not found")}}(_,Backbone)}).call(a),typeof Backbone!="undefined"&&(Backbone.Vertebrae=function(a){var b,e,f;typeof this.persist=="function"&&(this.persist=this.persist());if(this.persist&&(e=this.persist.length))for(b=0;b<e;b++)this.persist[b].prototype.localStorage=new Backbone.Storage(this.profile||"");_.each(this.routes,function(a,b){c[b]=a;if(f=a.model||a.collection)f.prototype.localStorage=new Backbone.Storage(a.profile||"")});if(typeof jQuery!="undefined"){jQuery.vertebrae.options.testRoute=function(a,b){return d(a).exec(b)};return jQuery.vertebrae(this.routes||{})}},Backbone.Vertebrae.extend=Backbone.Model.extend)})(this)